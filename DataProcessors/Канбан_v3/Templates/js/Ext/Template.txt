<script>
  // Переменная для хранения ссылки на перетаскиваемый элемент
  let draggedItem = null;

  function onClickItem(itemID) {
    const eventData = {
      event: "ClickItem", // тип события
      itemId: itemID, // ID элемента
    };
    pushEvent(eventData);
  }

  /**
   * Функция вызывается при начале перетаскивания элемента.
   * @param {Event} event - Событие dragstart
   */
  function onDragStart(event) {
    // Сохраняем ссылку на перетаскиваемый элемент
    draggedItem = event.target;

    // Сохраняем ID перетаскиваемого элемента в объект dataTransfer
    event.dataTransfer.setData("text/plain", event.target.dataset.id);

    // Скрываем элемент во время перетаскивания (для улучшения UX)
    setTimeout(() => {
      event.target.style.display = "none";
    }, 0);
  }

  /**
   * Функция вызывается при завершении перетаскивания элемента (успешном или нет).
   * @param {Event} event - Событие dragend
   */
  function onDragEnd(event) {
    // Восстанавливаем видимость элемента в любом случае
    event.target.style.display = "block";
  }

  /**
   * Функция вызывается, когда элемент перетаскивается над целевой областью.
   * @param {Event} event - Событие dragover
   */
  function onDragOver(event) {
    // Разрешаем дроп (по умолчанию браузеры запрещают дроп)
    event.preventDefault();
  }

  /**
   * Функция вызывается, когда элемент отпускается в целевой области.
   * @param {Event} event - Событие drop
   */
  function onDrop(event) {
    // Отменяем стандартное поведение браузера
    event.preventDefault();

    // Получаем ID категории, куда был перемещен элемент
    const categoryId = event.currentTarget.dataset.categoryId;

    // Находим контейнер задач (.items-container) внутри целевой категории
    const targetContainer = event.currentTarget.querySelector('.items-container');

    // Получаем ID перетаскиваемого элемента из объекта dataTransfer
    const itemId = event.dataTransfer.getData("text/plain");

    // Находим все задачи в целевом контейнере
    const items = Array.from(targetContainer.querySelectorAll('.item'));

    // Определяем позицию курсора относительно элементов
    const mouseY = event.clientY; // Позиция курсора по вертикали
    let insertBeforeIndex = -1; // Индекс элемента, перед которым нужно вставить задачу

    // Проходим по всем задачам в контейнере
    for (let i = 0; i < items.length; i++) {
      const itemRect = items[i].getBoundingClientRect(); // Получаем размеры и позицию элемента
      if (mouseY < itemRect.top + itemRect.height / 2) {
        // Если курсор находится выше середины элемента, вставляем перед ним
        insertBeforeIndex = i;
        break;
      }
    }

    // Находим кнопку "Загрузить еще" в контейнере, если она есть
    const loadMoreButton = targetContainer.querySelector('.load-more-button');

    // Если индекс не найден, вставляем элемент в конец списка (перед кнопкой "Загрузить еще", если она есть)
    if (insertBeforeIndex === -1) {
      if (loadMoreButton) {
        targetContainer.insertBefore(draggedItem, loadMoreButton);
      } else {
        targetContainer.appendChild(draggedItem);
      }
    } else {
      // Вставляем элемент перед найденным элементом
      targetContainer.insertBefore(draggedItem, items[insertBeforeIndex]);
    }

    // Восстанавливаем видимость элемента
    draggedItem.style.display = "block";
    draggedItem = null;

    // Создаем событие и помещаем его в очередь
    const eventData = {
      event: "DropItem", // тип события
      itemId: itemId, // ID перетаскиваемого элемента
      categoryId: categoryId // ID категории, куда был перемещен элемент
    };
    pushEvent(eventData);
  }

  var queue = Array() // Очередь событий
  var queueHead = -1 // Указатель на начало очереди
  var queueTail = -1 // Указатель на конец очереди
  var totalEventCount = 0 //Количество обработанных событий

  /**
   * Функция для добавления события в очередь.
   * @param {Object} dataEvent - Объект с данными события
   */
  function pushEvent(dataEvent) {
    if (queueHead === queueTail && queueHead > -1) { //Если очередь пуста, сбросим указатели
      queueHead = queueTail = -1
    }
    queue[queueTail + 1] = JSON.stringify(dataEvent) //Преобразуем данные в JSON
    queueTail += 1
    totalEventCount += 1


    // Логируем добавленное событие
    console.log("Добавлено событие:", dataEvent);
  }

  function getEvent(index) {
    return queue[index]
  }

  /**
   * Функция вызывается при клике на кнопку "Загрузить еще".
   * @param {Element} buttonElement - Элемент кнопки, по которой был клик
   */
  function onLoadMoreClick(buttonElement) {
    const categoryElement = buttonElement.closest('.category');
    const categoryId = categoryElement.dataset.categoryId;

    // Создаем событие и помещаем его в очередь
    const eventData = {
      event: "LoadMore", // тип события
      categoryId: categoryId // ID категории
    };
    pushEvent(eventData);
  }

</script>
